# Sistema de Inventario Onoxfri - Backend PHP

Backend b√°sico pero funcional desarrollado en PHP puro para el sistema de inventario onoxfri.

## Estructura del Proyecto

```
backend/php-8.2.12/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ database.php          # Configuraci√≥n de conexi√≥n a base de datos
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îî‚îÄ‚îÄ AuthMiddleware.php    # Middleware de autenticaci√≥n y autorizaci√≥n
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ BaseModel.php         # Modelo base con operaciones CRUD b√°sicas
‚îÇ   ‚îú‚îÄ‚îÄ User.php             # Modelo de usuarios
‚îÇ   ‚îú‚îÄ‚îÄ Product.php          # Modelo de productos
‚îÇ   ‚îú‚îÄ‚îÄ Category.php         # Modelo de categor√≠as
‚îÇ   ‚îî‚îÄ‚îÄ Customer.php         # Modelo de clientes
‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îú‚îÄ‚îÄ BaseController.php   # Controlador base con utilidades comunes
‚îÇ   ‚îú‚îÄ‚îÄ AuthController.php   # Controlador de autenticaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ ProductController.php # Controlador de productos
‚îÇ   ‚îî‚îÄ‚îÄ CategoryController.php # Controlador de categor√≠as
```

## Caracter√≠sticas

### Base de Datos
- Conexi√≥n PDO a MySQL/MariaDB
- Base de datos: `onoxfri`
- Configuraci√≥n flexible de conexi√≥n
- Manejo de transacciones

### Autenticaci√≥n y Autorizaci√≥n
- Sistema de login/logout
- Gesti√≥n de sesiones
- Control de permisos basado en roles
- Middleware de protecci√≥n de rutas

### Modelos
- Patr√≥n Active Record b√°sico
- Operaciones CRUD completas
- Relaciones entre entidades
- Validaciones b√°sicas

### Controladores
- Arquitectura RESTful
- Respuestas JSON estructuradas
- Manejo de errores consistente
- Logging de acciones

## Uso B√°sico

### Configuraci√≥n de Base de Datos

1. Crear la base de datos `onoxfri` en MySQL/MariaDB
2. Ejecutar el archivo `database-scheme/scheme.sql` para crear las tablas
3. Configurar las credenciales en `config/database.php` si es necesario

### Inicio R√°pido

```php
<?php
// Incluir archivos necesarios
require_once 'config/database.php';
require_once 'middleware/AuthMiddleware.php';
require_once 'models/Product.php';

// Crear instancia de producto
$productModel = new Product();

// Obtener productos activos
$products = $productModel->getActiveWithStock();

// Crear nuevo producto
$newProduct = $productModel->create([
    'sku' => 'PROD-001',
    'name' => 'Producto de ejemplo',
    'price' => 100.00,
    'cost' => 60.00,
    'min_stock' => 5,
    'is_active' => 1
]);
?>
```

### Autenticaci√≥n

```php
<?php
require_once 'controller/AuthController.php';

$authController = new AuthController();

// Login
$authController->handleRequest(); // POST /api/auth/login
// Body: {"email": "admin@example.com", "password": "password"}

// Logout
$authController->handleRequest(); // DELETE /api/auth/logout
?>
```

### API Endpoints

#### Autenticaci√≥n
- `POST /api/auth/login` - Iniciar sesi√≥n
- `POST /api/auth/register` - Registrar usuario
- `DELETE /api/auth/logout` - Cerrar sesi√≥n

#### Productos
- `GET /api/products` - Listar productos
- `GET /api/products/active` - Productos activos con stock
- `GET /api/products/{id}` - Obtener producto espec√≠fico
- `GET /api/products/search?q=termino` - Buscar productos
- `GET /api/products/low-stock` - Productos con stock bajo
- `POST /api/products/create` - Crear producto
- `PUT /api/products/{id}` - Actualizar producto
- `DELETE /api/products/{id}` - Eliminar producto

#### Categor√≠as
- `GET /api/categories` - Listar categor√≠as
- `GET /api/categories/with-count` - Categor√≠as con conteo de productos
- `POST /api/categories/create` - Crear categor√≠a
- `PUT /api/categories/{id}` - Actualizar categor√≠a
- `DELETE /api/categories/{id}` - Eliminar categor√≠a

## Seguridad

- Todas las rutas requieren autenticaci√≥n
- Sanitizaci√≥n de datos de entrada
- Validaci√≥n de permisos por roles
- Logging de acciones del usuario
- Protecci√≥n contra ataques comunes

## Desarrollo

### Agregar Nuevo Modelo

1. Crear archivo en `models/NombreModelo.php`
2. Extender `BaseModel`
3. Definir propiedades: `$table`, `$primaryKey`, `$fillable`

### Agregar Nuevo Controlador

1. Crear archivo en `controller/NombreController.php`
2. Extender `BaseController`
3. Implementar m√©todos HTTP seg√∫n necesidades

## Notas

- C√≥digo PHP puro sin frameworks externos
- Compatible con PHP 8.2+
- Uso de PDO para seguridad en consultas
- Arquitectura modular y extensible
- Listo para integraci√≥n con frontend Vue.js

## Pr√≥ximos Pasos

- Implementar m√°s controladores (Customer, Supplier, Reports)
- Agregar validaciones m√°s avanzadas
- Implementar sistema de cach√©
- Agregar tests unitarios
- Documentaci√≥n de API completa
# Sistema de Inventario Onoxfri - Backend PHP

Backend b√°sico pero funcional desarrollado en PHP puro para el sistema de inventario onoxfri.

## ‚úÖ Estructura Creada y Corregida

### Directorios y archivos principales:
- **config/database.php** - Configuraci√≥n completa de conexi√≥n PDO a MySQL/MariaDB
- **middleware/AuthMiddleware.php** - Sistema de autenticaci√≥n y autorizaci√≥n con sesiones
- **models/** - Modelos basados en tu esquema de base de datos:
  - BaseModel.php (clase base con operaciones CRUD mejoradas)
  - User.php (gesti√≥n de usuarios y roles - **Completamente corregido**)
  - Product.php (productos con gesti√≥n de stock e inventario)
  - Category.php (categor√≠as con conteo de productos)
  - Customer.php (gesti√≥n de clientes)
  - Role.php (gesti√≥n de roles y permisos)
- **controller/** - Controladores con arquitectura RESTful:
  - BaseController.php (funcionalidades comunes)
  - AuthController.php (login/logout/registro)
  - ProductController.php (operaciones CRUD completas de productos)
  - CategoryController.php (gesti√≥n de categor√≠as)
- **README.md** - Esta documentaci√≥n

## üîß Correcciones Implementadas

### Modelo User.php - Problemas Solucionados:
- ‚úÖ **Propiedad $user definida**: Ahora usa `$currentUser` con m√©todos apropiados
- ‚úÖ **Validaciones completas**: Email √∫nico, formato v√°lido, campos requeridos
- ‚úÖ **Manejo de errores**: Try-catch en todos los m√©todos cr√≠ticos
- ‚úÖ **M√∫ltiples roles**: Soporte completo para usuarios con m√∫ltiples roles
- ‚úÖ **M√©todos seguros**: `verifyPassword()` y `getUserRoles()` ahora funcionan correctamente

### BaseModel.php - Mejoras:
- ‚úÖ **Manejo de errores mejorado**: Excepciones descriptivas
- ‚úÖ **Validaci√≥n de datos**: Respeta campos `$fillable`
- ‚úÖ **Transacciones**: Soporte completo para operaciones at√≥micas

### AuthMiddleware.php - Actualizaciones:
- ‚úÖ **M√∫ltiples roles**: Compatible con `GROUP_CONCAT` de roles
- ‚úÖ **M√©todo hasRole()**: Funciona con arrays de roles

## üöÄ Caracter√≠sticas Implementadas

### Base de Datos
- Conexi√≥n PDO segura a la base de datos `onoxfri`
- Manejo de transacciones
- Configuraci√≥n flexible

### Autenticaci√≥n y Autorizaci√≥n
- Sistema de login/logout con sesiones
- Control de permisos basado en roles
- Soporte para m√∫ltiples roles por usuario
- Middleware de protecci√≥n de rutas

### Modelos
- Patr√≥n Active Record b√°sico
- Operaciones CRUD completas
- Relaciones entre entidades
- Validaciones completas
- Manejo robusto de errores

### API RESTful
- Endpoints JSON estructurados
- Manejo de errores consistente
- Logging de acciones
- Sanitizaci√≥n de datos

## üìã Endpoints Disponibles

### Autenticaci√≥n
- `POST /api/auth/login` - Iniciar sesi√≥n
- `POST /api/auth/register` - Registrar usuario
- `DELETE /api/auth/logout` - Cerrar sesi√≥n

### Productos
- `GET /api/products` - Listar productos
- `GET /api/products/active` - Productos activos con stock
- `GET /api/products/{id}` - Obtener producto espec√≠fico
- `GET /api/products/search?q=termino` - Buscar productos
- `GET /api/products/low-stock` - Productos con stock bajo
- `POST /api/products/create` - Crear producto
- `PUT /api/products/{id}` - Actualizar producto
- `DELETE /api/products/{id}` - Eliminar producto

### Categor√≠as
- `GET /api/categories` - Listar categor√≠as
- `GET /api/categories/with-count` - Categor√≠as con conteo de productos
- `POST /api/categories/create` - Crear categor√≠a
- `PUT /api/categories/{id}` - Actualizar categor√≠a
- `DELETE /api/categories/{id}` - Eliminar categor√≠a

## üîê Seguridad

- Todas las rutas requieren autenticaci√≥n
- Sanitizaci√≥n de datos de entrada
- Validaci√≥n de permisos por roles
- Logging de acciones del usuario
- Protecci√≥n contra ataques comunes
- Hash seguro de contrase√±as (bcrypt)

## üõ†Ô∏è Uso B√°sico

### Configuraci√≥n de Base de Datos

1. Crear la base de datos `onoxfri` en MySQL/MariaDB
2. Ejecutar el archivo `database-scheme/scheme.sql` para crear las tablas
3. Configurar las credenciales en `config/database.php` si es necesario

### Ejemplo de Uso

```php
<?php
// Incluir archivos necesarios
require_once 'config/database.php';
require_once 'models/User.php';
require_once 'models/Product.php';

// Crear usuario
$userModel = new User();
try {
    $user = $userModel->createUser([
        'name' => 'Juan P√©rez',
        'email' => 'juan@example.com',
        'password' => 'contrase√±a123'
    ]);

    // Asignar m√∫ltiples roles
    $userModel->assignRole($user['id'], 1); // Superusuario
    $userModel->assignRole($user['id'], 2); // Gerente

    echo "Usuario creado exitosamente";
} catch (Exception $e) {
    echo "Error: " . $e->getMessage();
}
?>
```

## üìö Desarrollo

### Agregar Nuevo Modelo

1. Crear archivo en `models/NombreModelo.php`
2. Extender `BaseModel`
3. Definir propiedades: `$table`, `$primaryKey`, `$fillable`

### Agregar Nuevo Controlador

1. Crear archivo en `controller/NombreController.php`
2. Extender `BaseController`
3. Implementar m√©todos HTTP seg√∫n necesidades

## ‚ú® Caracter√≠sticas Avanzadas

- **M√∫ltiples roles por usuario**: Un usuario puede tener varios roles simult√°neamente
- **Gesti√≥n granular de permisos**: Sistema de permisos detallado
- **Transacciones de base de datos**: Para operaciones at√≥micas
- **Validaciones robustas**: En todos los niveles
- **Logging completo**: Todas las acciones quedan registradas
- **Arquitectura escalable**: F√°cil de extender y mantener

## üöÄ Pr√≥ximos Pasos Sugeridos

- Implementar m√°s controladores (Customer, Supplier, Reports)
- Agregar sistema de cach√© para mejorar rendimiento
- Implementar tests unitarios
- Agregar documentaci√≥n de API con Swagger/OpenAPI
- Implementar rate limiting para la API
- Agregar sistema de backups autom√°ticos

## üí° Notas

- C√≥digo PHP puro sin frameworks externos
- Compatible con PHP 8.2+
- Uso de PDO para seguridad en consultas
- Arquitectura modular y extensible
- Listo para integraci√≥n con frontend Vue.js
- Manejo robusto de errores en toda la aplicaci√≥n